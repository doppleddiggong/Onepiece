name: Generate Doxygen

on:
  push:
    branches:
      - main
    paths:
      - 'Source/**'
      - 'Plugins/**'
      - 'Doxyfile'
  pull_request:
    paths:
      - 'Source/**'
      - 'Plugins/**'
      - 'Doxyfile'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Doxygen
      run: sudo apt-get update && sudo apt-get install -y doxygen graphviz

    - name: Download Doxygen Awesome CSS
      run: |-
        wget https://raw.githubusercontent.com/jothepro/doxygen-awesome-css/main/doxygen-awesome.css
        mkdir -p docs/html
        mv doxygen-awesome.css docs/html/

    - name: Generate Doxygen documentation
      run: doxygen Doxyfile

    - name: Prepare staging directory
      run: |
        mkdir -p Doxygen/html
        cp -R docs/html/. Doxygen/html/

    - name: Checkout existing GitHub Pages content
      id: pages-cache
      uses: actions/checkout@v4
      continue-on-error: true
      with:
        ref: gh-pages
        path: ./_site

    - name: Prepare GitHub Pages content
      run: |
        set -euo pipefail
        mkdir -p public

        if [ -d "_site" ]; then
          if command -v rsync >/dev/null 2>&1; then
            rsync -a --exclude '.git' _site/ public/
          else
            cp -R _site/. public/
            rm -rf public/.git
          fi
        elif [ -f ".github/gh-pages-index.html" ]; then
          cp .github/gh-pages-index.html public/index.html
        fi

        rm -rf public/doxygen
        mkdir -p public/doxygen
        cp -R Doxygen/html/. public/doxygen/

    - name: Upload GitHub Pages artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./public

    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main'
      id: deployment
      uses: actions/deploy-pages@v4

    - name: Summary
      if: github.ref == 'refs/heads/main'
      run: |
        echo "âœ… Doxygen documentation has been built and deployed!"
        echo "ðŸ”— URL: ${{ steps.deployment.outputs.page_url }}"

