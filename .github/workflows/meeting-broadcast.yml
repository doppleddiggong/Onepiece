name: Meeting Log Broadcast

on:
  push:
    branches:
      - main
    paths:
      - 'Documents/Meeting/**'
  
  # 수동 실행을 위한 workflow_dispatch 추가
  workflow_dispatch:
    inputs:
      meeting_log_path:
        description: '알림을 보낼 회의록 파일 경로 (예: Documents/Meeting/Meeting_251112_Daily.md)'
        required: true
      force_send:
        description: 'config.yml 설정을 무시하고 강제로 알림을 보낼지 여부'
        type: boolean
        default: true
      honkit_keep_files:
        description: 'HonKit 배포 시 기존 파일을 유지할지 여부 (false = 정리 후 배포)'
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  broadcast:
    runs-on: ubuntu-latest
    # config.yml의 전체 알림(enabled)과 회의록 알림(meeting_log_enabled)이 모두 true일 때 실행
    # 또는 수동 실행 시 force_send가 true이면 config 설정을 무시하고 실행
    if: (fromJSON(needs.setup.outputs.config).discord_enabled == true && fromJSON(needs.setup.outputs.config).discord_meeting_log_enabled == true) || (github.event_name == 'workflow_dispatch' && github.event.inputs.force_send == 'true')

    needs: setup

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: docs
          fetch-depth: 0

      - name: Get changed file and commit info
        id: file_info
        run: |
          set -e

          # 푸시된 커밋에서 변경된 회의록 파일 찾기
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # 수동 실행 시 입력받은 경로 사용
            CHANGED_FILE="${{ github.event.inputs.meeting_log_path }}"
            COMMIT_SHA=$(git rev-parse HEAD) # 현재 브랜치의 최신 커밋 사용
          else
            # 푸시 이벤트 시 기존 로직 사용
            # -M 옵션으로 리네임을 단일 라인으로 감지하고, 마지막 필드만 추출해 신규 경로만 가져온다
            CHANGED_FILE=$(git diff-tree -M --no-commit-id --name-status -r ${{ github.sha }} \
              | awk '$NF ~ /^Documents\/Meeting\// { print $NF; exit }')
            COMMIT_SHA="${{ github.sha }}"
          fi
          
          echo "changed_file=$CHANGED_FILE" >> $GITHUB_OUTPUT
          
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/$COMMIT_SHA"
          echo "commit_url=$COMMIT_URL" >> $GITHUB_OUTPUT
          
          COMMIT_MESSAGE=$(git log -1 --pretty=%B $COMMIT_SHA | tr -d '\n' | tr -d '\r')
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT

      - name: Determine HonKit keep_files flag
        id: honkit_flag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.honkit_keep_files }}" ]; then
            KEEP_FILES="${{ github.event.inputs.honkit_keep_files }}"
          else
            KEEP_FILES="true"
          fi
          echo "keep_files=$KEEP_FILES" >> $GITHUB_OUTPUT

      - name: Discord Notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_MEETING_URL || secrets.DISCORD_WEBHOOK }}
          COMMIT_URL: ${{ steps.file_info.outputs.commit_url }}
          COMMIT_MESSAGE: ${{ steps.file_info.outputs.commit_message }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "⚠️ DISCORD_WEBHOOK secret이 설정되지 않았습니다. Discord 알림을 건너뜁니다."
          elif [ -z "${{ steps.file_info.outputs.changed_file }}" ]; then
            echo "⚠️ 변경된 회의록 파일이 없습니다. 알림을 건너뜁니다."
          else
            # Honkit URL 생성 (예: Documents/Meeting/Meeting_251112.md -> Meeting/Meeting_251112.html)
            FILE_PATH="${{ steps.file_info.outputs.changed_file }}"
            HTML_PATH="${FILE_PATH#Documents/}" # 'Documents/' 접두사 제거
            HTML_PATH="${HTML_PATH%.md}.html"   # 확장자를 .html로 변경
            HONKIT_URL="https://doppleddiggong.github.io/Onepiece/docs/${HTML_PATH}"

            chmod +x .github/scripts/devlog/send_discord.py
            python .github/scripts/devlog/send_discord.py \
              --webhook-url "$DISCORD_WEBHOOK" \
              --type "meeting_log" \
              --devlog-file "$FILE_PATH" \
              --devlog-url "$HONKIT_URL"
          fi

      - name: Trigger HonKit Build
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: honkit-build
          client-payload: '{"ref": "docs", "trigger": "meeting-broadcast", "keep_files": ${{ steps.honkit_flag.outputs.keep_files }}}'

  # daily-report.yml을 참조하여 config를 읽는 setup job 추가
  setup:
    runs-on: ubuntu-latest
    outputs:
      config: ${{ steps.config.outputs.json_config }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: docs

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install pyyaml

      - name: Load config and output as JSON
        id: config
        run: |
          CONFIG_JSON=$(python3 -c "import yaml, json; config = yaml.safe_load(open('.github/config.yml')); print(json.dumps({'discord_enabled': config.get('discord', {}).get('enabled', False), 'discord_meeting_log_enabled': config.get('discord', {}).get('meeting_log_enabled', False)}))")
          echo "json_config=$CONFIG_JSON" >> $GITHUB_OUTPUT
