name: Generate HonKit

on:
  # DevLog ë˜ëŠ” Planning í´ë”ê°€ ì—…ë°ì´íŠ¸ë  ë•Œ ìë™ ì‹¤í–‰
  push:
    branches:
      - main
      - docs
    paths:
      - 'Documents/DevLog/**'
      - 'Documents/Meeting/**'
      - 'Documents/meeting/**'
      - 'Documents/Planning/**'
      - 'Documents/book.json'
      - '.github/scripts/generate_summary.py'

  # Daily/Weekly report ì™„ë£Œ í›„ íŠ¸ë¦¬ê±°
  repository_dispatch:
    types: [honkit-build]

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Collect meeting log changes
        id: meeting_changes
        if: github.event_name == 'push'
        env:
          BEFORE_SHA: ${{ github.event.before }}
          AFTER_SHA: ${{ github.sha }}
        run: |
          python3 <<'PY'
import json
import os
import subprocess
from pathlib import Path

before = os.environ.get('BEFORE_SHA')
after = os.environ.get('AFTER_SHA')

def run_git(command):
    result = subprocess.run(command, check=True, text=True, capture_output=True)
    return result.stdout

def gather_changed_lines(before_sha: str | None, after_sha: str) -> list[str]:
    zero_before = not before_sha or set(before_sha) == {'0'}
    if zero_before:
        cmd = ['git', 'show', '--name-status', after_sha]
    else:
        cmd = ['git', 'diff', '--name-status', before_sha, after_sha]
    output = run_git(cmd)
    return [line.strip() for line in output.splitlines() if line.strip()]

changed_lines = gather_changed_lines(before, after)

meeting_files: list[str] = []
for line in changed_lines:
    parts = line.split('\t')
    if len(parts) < 2:
        continue
    status = parts[0]
    new_path = parts[-1]
    if not status:
        continue
    if status[0] not in {'A', 'M', 'R', 'C'}:
        continue
    lowered = new_path.lower()
    if not lowered.startswith('documents/meeting/'):
        continue
    if not lowered.endswith('.md'):
        continue
    if new_path not in meeting_files:
        meeting_files.append(new_path)

file_infos: list[dict[str, str | int]] = []

for file_path in meeting_files:
    log_cmd = ['git', 'log', '-1', '--format=%H%n%ct%n%B', after, '--', file_path]
    log_output = run_git(log_cmd).strip()
    lines = [entry.strip() for entry in log_output.splitlines()]

    if len(lines) >= 2:
        commit_sha = lines[0]
        try:
            timestamp = int(lines[1])
        except ValueError:
            timestamp = 0
        message_lines = lines[2:]
    else:
        commit_sha = after
        timestamp = 0
        message_lines = []

    message_compact = ' '.join(line for line in message_lines if line)
    if not message_compact:
        subject_cmd = ['git', 'log', '-1', '--format=%s', after, '--', file_path]
        message_compact = run_git(subject_cmd).strip()

    file_infos.append(
        {
            'path': file_path,
            'sha': commit_sha,
            'timestamp': timestamp,
            'message': message_compact,
        }
    )

latest_info = None
if file_infos:
    latest_info = max(file_infos, key=lambda info: (int(info.get('timestamp', 0)), str(info.get('path'))))

output_path = Path(os.environ['GITHUB_OUTPUT'])
with output_path.open('a', encoding='utf-8') as fh:
    fh.write(f"changed_count={len(file_infos)}\n")
    if file_infos:
        fh.write('changed_files_json<<EOF\n')
        fh.write(json.dumps(file_infos))
        fh.write('\nEOF\n')
    if latest_info:
        fh.write(f"latest_file={latest_info['path']}\n")
        fh.write(f"latest_commit_sha={latest_info['sha']}\n")
        fh.write(f"latest_commit_message={latest_info['message']}\n")
PY

      - name: Sync docs branch content
        run: |
          git fetch origin docs
          git checkout docs

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Load notification config
        id: config
        run: |
          python3 <<'PY'
import os
from pathlib import Path

config_path = Path('.github/config.yml')
discord_enabled = False
meeting_enabled = False
current_section = None

if config_path.exists():
    for raw_line in config_path.read_text(encoding='utf-8').splitlines():
        stripped = raw_line.strip()
        if not stripped or stripped.startswith('#'):
            continue
        if raw_line.startswith((' ', '\t')):
            if current_section != 'discord':
                continue
            if ':' not in stripped:
                continue
            key, value = [part.strip() for part in stripped.split(':', 1)]
            lowered = value.lower()
            if key == 'enabled':
                discord_enabled = lowered in {'true', 'yes', 'on', '1'}
            elif key == 'meeting_log_enabled':
                meeting_enabled = lowered in {'true', 'yes', 'on', '1'}
        else:
            current_section = stripped.rstrip(':')

output_path = Path(os.environ['GITHUB_OUTPUT'])
with output_path.open('a', encoding='utf-8') as fh:
    fh.write(f"discord_enabled={'true' if discord_enabled else 'false'}\n")
    fh.write(f"discord_meeting_log_enabled={'true' if meeting_enabled else 'false'}\n")
PY

      - name: Generate SUMMARY.md
        run: |
          python .github/scripts/generate_summary.py
          echo "âœ… SUMMARY.md has been generated"

      - name: Discord Notification for Meeting Logs
        if: steps.config.outputs.discord_enabled == 'true' && steps.config.outputs.discord_meeting_log_enabled == 'true' && steps.meeting_changes.outputs.changed_count != '' && steps.meeting_changes.outputs.changed_count != '0'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_MEETING_URL || secrets.DISCORD_WEBHOOK }}
          CHANGED_COUNT: ${{ steps.meeting_changes.outputs.changed_count }}
          CHANGED_FILE: ${{ steps.meeting_changes.outputs.latest_file }}
          COMMIT_SHA: ${{ steps.meeting_changes.outputs.latest_commit_sha }}
          COMMIT_MESSAGE: ${{ steps.meeting_changes.outputs.latest_commit_message }}
          COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ steps.meeting_changes.outputs.latest_commit_sha }}
        run: |
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "âš ï¸ DISCORD_WEBHOOK secretì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Discord ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          if [ -z "$CHANGED_FILE" ]; then
            echo "âš ï¸ íšŒì˜ë¡ ë³€ê²½ íŒŒì¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì•Œë¦¼ì„ ê±´ë„ˆëœë‹ˆë‹¤."
            exit 0
          fi

          FILE_PATH="$CHANGED_FILE"
          HTML_PATH="${FILE_PATH#Documents/}"
          HTML_PATH="${HTML_PATH%.md}.html"
          HONKIT_URL="https://doppleddiggong.github.io/Onepiece/docs/${HTML_PATH}"

          if [ ! -f "$FILE_PATH" ]; then
            if [ -z "$COMMIT_SHA" ]; then
              echo "âŒ COMMIT_SHAë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              exit 1
            fi

            if git cat-file -e "$COMMIT_SHA:$FILE_PATH" 2>/dev/null; then
              mkdir -p "$(dirname "$FILE_PATH")"
              git show "$COMMIT_SHA:$FILE_PATH" > "$FILE_PATH"
            else
              echo "âŒ íšŒì˜ë¡ íŒŒì¼ì„ ì»¤ë°‹ $COMMIT_SHA ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $FILE_PATH"
              exit 1
            fi
          fi

          chmod +x .github/scripts/devlog/send_discord.py

          if [ "$CHANGED_COUNT" = "1" ]; then
            python .github/scripts/devlog/send_discord.py \
              --webhook-url "$DISCORD_WEBHOOK" \
              --type "meeting_log" \
              --devlog-file "$FILE_PATH" \
              --devlog-url "$HONKIT_URL"
          else
            python .github/scripts/devlog/send_discord.py \
              --webhook-url "$DISCORD_WEBHOOK" \
              --type "meeting_log" \
              --devlog-file "$FILE_PATH" \
              --devlog-url "$HONKIT_URL" \
              --notice "ìµœê·¼ì— ë“±ë¡ëœ íšŒì˜ë¡ì´ ë‹¤ìˆ˜ ì¡´ì¬í•©ë‹ˆë‹¤. ê°€ì¥ ìµœê·¼ ë¬¸ì„œë¥¼ ì•ˆë‚´ë“œë¦½ë‹ˆë‹¤."
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install HonKit and plugins
        run: |
          npm install -g honkit
          npm install -g gitbook-plugin-theme-comscore
          npm install -g gitbook-plugin-github
          npm install -g gitbook-plugin-collapsible-menu
          npm install -g gitbook-plugin-back-to-top-button
          npm install -g gitbook-plugin-search-plus
          npm install -g gitbook-plugin-expandable-chapters-small
          npm install -g gitbook-plugin-page-toc-button
          npm install -g gitbook-plugin-anchor-navigation-ex
          npm install -g gitbook-plugin-code
          npm install -g gitbook-plugin-alerts
          npm install -g gitbook-plugin-emphasize
          npm install -g gitbook-plugin-klipse
          npm install -g honkit-plugin-mermaid

      - name: Build HonKit
        working-directory: Documents
        run: |
          honkit build

      - name: Resolve keep_files flag
        id: keepflag
        env:
          PAYLOAD_KEEP_FILES: ${{ github.event.client_payload.keep_files }}
        run: |
          KEEP_FILES="true"
          if [ -n "${PAYLOAD_KEEP_FILES}" ]; then
            KEEP_FILES="${PAYLOAD_KEEP_FILES}"
          fi
          echo "keep_files=$KEEP_FILES" >> $GITHUB_OUTPUT

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./Documents/_book
          publish_branch: gh-pages
          destination_dir: docs
          enable_jekyll: false
          force_orphan: false
          keep_files: ${{ steps.keepflag.outputs.keep_files == 'true' }}

      - name: Summary
        run: |
          echo "âœ… HonKit documentation has been built and deployed!"
          echo "ğŸ“š Documentation will be available at: https://doppleddiggong.github.io/Onepiece/docs/"
