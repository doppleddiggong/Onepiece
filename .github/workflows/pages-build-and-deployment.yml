name: Deploy to GitHub Pages

on:
  # `honkit.yml`ì˜ `build` ì¡ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ì‹¤í–‰
  workflow_run:
    workflows: [ "Generate HonKit" ]
    types:
      - completed

  # ìˆ˜ë™ìœ¼ë¡œ ë°°í¬í•  ë•Œ ì‚¬ìš©
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  notify:
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download artifact metadata
        id: artifact_meta
        uses: dawidd6/action-download-artifact@v6
        with:
          workflow: honkit.yml
          workflow_conclusion: success
          name: github-pages
          path: .
          
      - name: Send Discord Notification
        env:
          EVENT_NAME: ${{ fromJson(steps.artifact_meta.outputs.artifact_entries)[0].source_workflow_run.event }}
          TRIGGER: ${{ fromJson(fromJson(steps.artifact_meta.outputs.artifact_entries)[0].source_workflow_run.triggering_actor.payload).client_payload.trigger || '' }}
          LATEST_FILE: ${{ fromJson(fromJson(steps.artifact_meta.outputs.artifact_entries)[0].source_workflow_run.triggering_actor.payload).client_payload.latest_file || '' }}
          DISCORD_WEBHOOK_DEFAULT: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_WEBHOOK_MEETING: ${{ secrets.DISCORD_WEBHOOK_MEETING_URL }}
        run: |
          set -euo pipefail

          WEBHOOK="$DISCORD_WEBHOOK_DEFAULT"
          LABEL="ë¬¸ì„œ"
          ICON="âœ…"
          TITLE="ë¬¸ì„œ"
          URL="https://doppleddiggong.github.io/Onepiece/docs/"

          case "$TRIGGER" in
            "meeting-update")
              WEBHOOK="${DISCORD_WEBHOOK_MEETING:-$DISCORD_WEBHOOK_DEFAULT}"
              LABEL="íšŒì˜ë¡"
              ICON="ğŸ“˜"
              ;;
            "daily-update")
              LABEL="ì¼ì¼ ì¼ì§€"
              ICON="ğŸ—“ï¸"
              ;;
            "weekly-update")
              LABEL="ì£¼ê°„ ì¼ì§€"
              ICON="ğŸ“…"
              ;;
          esac

          if [ -n "$LATEST_FILE" ]; then
            TITLE=$(basename "$LATEST_FILE")
            URL="https://doppleddiggong.github.io/Onepiece/docs/${LATEST_FILE#Documents/}"
            URL="${URL%.md}.html"
          fi

          MSG="${ICON} ${LABEL} **${TITLE}** ê°€ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nğŸ”— ë°”ë¡œê°€ê¸°"

          if [ -z "$WEBHOOK" ]; then
            echo "âš ï¸ Discord ì›¹í›…ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì•Œë¦¼ ìƒëµ"
            exit 0
          fi

          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\": \"$MSG\"}" "$WEBHOOK"